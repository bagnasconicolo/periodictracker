<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PeriodicTracker</title>
  <style>
    /* =============================
       GLOBAL STYLING & LAYOUT
       ============================= */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100vh;
      box-sizing: border-box;
      font-family: "Segoe UI", Tahoma, Arial, sans-serif;
      background: linear-gradient(135deg, #fdfdfd 0%, #e8f0fd 100%);
      overflow-x: hidden;
    }
    body {
      display: flex;
      flex-direction: row;
      gap: 15px;
      margin: 0;
      padding: 10px;
      max-width: 100vw;
    }
    /* NORMAL MODE styles */
    .left-column {
      flex: 1;
      max-width: 1200px;
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.12);
      padding: 15px;
      display: flex;
      flex-direction: column;
    }
    #topBanner {
      text-align: center;
      margin-bottom: 15px;
    }
    #topBanner img {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
    }
    #menuBar {
      margin-bottom: 10px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-weight: bold;
      font-style: italic;
      background: #474747;
      color: #fff;
      text-align: center;
    }
    #menuBar a {
      margin-right: 10px;
      color: #ffffff;
      text-decoration: none;
    }
    #menuBar a:hover {
      text-decoration: underline;
    }
    #darkModeToggle {
      float: right;
      background: #222;
      color: #fff;
      border: none;
      padding: 6px 10px;
      cursor: pointer;
    }
    #darkModeToggle:hover {
      background: #444;
    }
    #userStatusBar {
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-weight: bold;
    }
    #topControls {
      margin-bottom: 15px;
      border: 1px solid #e0e0e0;
      background: #fafafa;
      padding: 10px;
      border-radius: 4px;
    }
    #topControls .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    input, select, button {
      margin: 3px 0;
      padding: 8px 12px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    input::placeholder {
      color: #95a5a6;
      font-style: italic;
    }
    input:invalid {
      border-color: #e74c3c;
    }
    input:valid {
      border-color: #27ae60;
    }
    button {
      background: #3498db;
      color: #fff;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      font-weight: 500;
    }
    button:hover {
      background: #1f78b4;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    button:focus {
      outline: 2px solid #74b9ff;
      outline-offset: 2px;
    }
    /* Button variants */
    .btn-success { background: #27ae60; }
    .btn-success:hover { background: #219a54; }
    .btn-danger { background: #e74c3c; }
    .btn-danger:hover { background: #c0392b; }
    .btn-warning { background: #f39c12; }
    .btn-warning:hover { background: #d68910; }
    .btn-secondary { background: #95a5a6; }
    .btn-secondary:hover { background: #7f8c8d; }
    .periodic-container {
      position: relative;
      flex: 1;
      display: flex;
      flex-direction: column;
      margin-top: 10px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      overflow: auto; /* Allow scrolling instead of hidden */
      max-height: calc(100vh - 150px); /* Better height calculation */
    }
    .sticky-fixed {
      position: fixed;
      top: 10px;
      left: 10px;
      right: 430px;
      z-index: 1000;
      background: #fff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      padding: 10px;
    }
    #periodicTable {
      border-collapse: collapse;
      margin-bottom: 10px;
    }
    #periodicTable td {
      width: 60px;
      height: 60px;
      text-align: center;
      vertical-align: middle;
      border: 1px solid #ddd;
      cursor: pointer;
      position: relative;
      transition: all 0.2s ease;
      background-size: cover;
      background-position: center;
      border-radius: 4px;
      font-weight: 600;
    }
    #periodicTable td:hover {
      background: #f8f9fa;
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      z-index: 10;
      border-color: #3498db;
    }
    #periodicTable td:active {
      transform: scale(0.95);
    }
    #periodicTable td.selected {
      outline: 3px solid #3498db;
      outline-offset: 2px;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { outline-color: #3498db; }
      50% { outline-color: #74b9ff; }
      100% { outline-color: #3498db; }
    }
    .atomic-number {
      position: absolute;
      top: 2px;
      left: 4px;
      font-size: 10px;
      color: #666;
      pointer-events: none;
    }
    .comment-badge {
      position: absolute;
      bottom: 2px;
      right: 4px;
      background-color: #ff6767;
      color: #fff;
      font-size: 0.7em;
      padding: 2px 4px;
      border-radius: 10px;
      pointer-events: none;
    }
    .sample-badge {
      position: absolute;
      bottom: 2px;
      left: 4px;
      background-color: green;
      color: #fff;
      font-size: 0.7em;
      padding: 2px 4px;
      border-radius: 10px;
      pointer-events: none;
    }
    .sub-block-container {
      margin-top: 8px;
    }
    .sub-block-container table {
      border-collapse: collapse;
      margin-top: 4px;
    }
    .sub-block-container td {
      width: 60px;
      height: 60px;
      text-align: center;
      vertical-align: middle;
      border: 1px solid #ddd;
      cursor: pointer;
      position: relative;
      transition: background 0.2s ease, outline 0.2s ease;
      background-size: cover;
      background-position: center;
    }
    .sub-block-container td:hover {
      background: #f0f0f0;
    }
    #counters {
      margin-top: 10px;
      font-weight: bold;
    }
    #statusChart {
      width: 200px;
      height: 200px;
      margin: 0 auto;
    }
    .cat-outline {
      outline: 3px solid #999;
      outline-offset: -3px;
    }
    .status-pure {
      background-color: #aaffaa !important;
    }
    .status-rep {
      background-color: #ffb3b3 !important;
    }
    .status-alloy {
      background-color: #b3b3ff !important;
    }
    .status-wish {
      background-color: #fffba1 !important;
    }
    #elementTooltip {
      position: absolute;
      background: #fff8d1;
      border: 1px solid #ccc;
      padding: 4px;
      display: none;
      z-index: 9999;
      pointer-events: none;
      font-size: 0.9em;
    }
    .details-panel {
      width: 400px;
      background: #fff;
      border: 1px solid #ccc;
      padding: 16px;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.12);
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow-y: auto; /* Allow scrolling if content exceeds */
      max-height: calc(100vh - 120px); /* Better height calculation */
    }
    .edit-mode {
      border: 2px solid #ffbb33 !important;
      background: #fff7e6 !important;
    }
    .view-mode {
      border: 2px solid #999 !important;
      background: #f0f0f0 !important;
    }
    #elementTitle {
      font-weight: bold;
      font-size: 1.1em;
      margin-bottom: 0;
      border-bottom: 1px solid #ddd;
      padding-bottom: 4px;
    }
    textarea {
      width: 100%;
      height: 70px;
      border-radius: 3px;
      border: 1px solid #ccc;
      padding: 6px;
      resize: vertical;
    }
    #previewImg {
      max-width: 100%;
      margin-top: 10px;
      border: 1px solid #ccc;
      display: none;
      border-radius: 4px;
    }
    .edit-fields {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    #samplesSection {
      border-top: 1px solid #ddd;
      padding-top: 10px;
      margin-top: 10px;
    }
    #samplesSection h3 {
      margin: 0 0 5px 0;
    }
    #samplesList {
      margin-bottom: 10px;
    }
    /* New: Add sample form */
    #addSampleForm {
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 4px;
      background: #f9f9f9;
    }
    /* In the add sample form, add a file input with name="image" */
    #addSampleForm input[type="file"] {
      display: block;
      margin-top: 5px;
    }
    #authorInfoModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 2px solid #333;
      padding: 20px;
      border-radius: 6px;
      display: none;
      min-width: 300px;
      max-width: 90vw;
      max-height: 80vh;
      overflow-y: auto;
      z-index: 9999;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      /* Auto-resize to content */
      width: auto;
      height: auto;
    }
    #authorInfoModal img {
      max-width: 100%;
      margin-top: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #authorInfoClose {
      margin-top: 10px;
      background: #999;
      border: none;
      color: #fff;
      padding: 8px 12px;
      border-radius: 3px;
      cursor: pointer;
    }
    #authorInfoClose:hover {
      background: #666;
    }
    .achievement-badge {
      margin: 4px;
      width: 74px;
      height: 74px;
      vertical-align: middle;
    }
    /* Loading states */
    .loading {
      position: relative;
      pointer-events: none;
      opacity: 0.7;
    }
    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 16px;
      height: 16px;
      margin: -8px 0 0 -8px;
      border: 2px solid #fff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Toast notifications */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #2c3e50;
      color: white;
      padding: 12px 20px;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 10000;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }
    .toast.show {
      transform: translateX(0);
    }
    .toast.success {
      background: #27ae60;
    }
    .toast.error {
      background: #e74c3c;
    }
    .toast.warning {
      background: #f39c12;
    }
    
    /* Button with profile picture styles */
    .btn-with-avatar {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-avatar {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid rgba(255,255,255,0.3);
    }
    .btn-avatar-placeholder {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(45deg, #4a90e2, #7b68ee);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 10px;
      font-weight: bold;
      border: 1px solid rgba(255,255,255,0.3);
    }
    #commentsContainer {
      background: #f0f8ff;
      border: 1px solid #ddd;
      padding: 8px;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 8px;
    }
    .add-comment-section {
      margin-top: 8px;
      background: #f9f9f9;
      border: 1px solid #ddd;
      padding: 8px;
      border-radius: 4px;
    }
    .add-comment-section input[type="text"] {
      width: 100%;
      padding: 6px 8px;
      margin-bottom: 4px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    .add-comment-section textarea {
      width: 100%;
      height: 60px;
      margin-bottom: 4px;
      resize: vertical;
    }
    .add-comment-section button {
      float: right;
    }
    /* New inline login UI for comments */
    #commentLoginSection {
      margin-bottom: 8px;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 3px;
      background: #f0f0f0;
      display: none;
    }
    #commentPostSection {
      display: none;
    }
    #toggleStickyBtn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #3498db;
      color: #fff;
      border: none;
      padding: 4px 8px;
      cursor: pointer;
      border-radius: 3px;
      z-index: 1001;
    }
    
    /* =============================
       ACCESSIBILITY STYLES
       ============================= */
    
    /* Screen reader only text */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    
    /* Help text styling */
    .help-text {
      font-size: 0.875em;
      color: #666;
      font-style: italic;
      margin-left: 8px;
    }
    
    
    /* Focus indicators */
    button:focus,
    input:focus,
    select:focus,
    textarea:focus,
    .periodic-container td:focus {
      outline: 2px solid #4a90e2;
      outline-offset: 2px;
      box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.2);
    }
    
    /* High contrast focus for periodic table */
    .periodic-container td:focus {
      outline: 3px solid #fff;
      outline-offset: -3px;
      box-shadow: 0 0 0 6px #4a90e2;
    }
    
    /* Skip link for keyboard navigation */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 6px;
      background: #000;
      color: #fff;
      padding: 8px;
      text-decoration: none;
      border-radius: 4px;
      z-index: 10000;
    }
    
    .skip-link:focus {
      top: 6px;
    }
    
    /* =============================
       RESPONSIVE DESIGN & MOBILE
       ============================= */
    
    /* Tablet and smaller devices */
    @media screen and (max-width: 1024px) {
      body {
        flex-direction: column;
        padding: 8px;
        gap: 10px;
      }
      
      .details-panel {
        width: 100%;
        max-width: none;
        order: -1; /* Move details panel to top on mobile */
      }
      
      .left-column {
        max-width: none;
      }
      
      #menuBar {
        font-size: 0.9em;
        padding: 6px;
      }
      
      #menuBar a {
        display: inline-block;
        margin: 2px 5px;
      }
    }
    
    /* Mobile phones */
    @media screen and (max-width: 768px) {
      body {
        padding: 4px;
        gap: 8px;
      }
      
      .left-column {
        padding: 10px;
      }
      
      .details-panel {
        padding: 12px;
      }
      
      /* Make periodic table more touch-friendly */
      .periodic-container td {
        min-width: 45px;
        min-height: 45px;
        font-size: 0.8em;
      }
      
      .sub-block-container td {
        width: 45px;
        height: 45px;
        font-size: 0.8em;
      }
      
      /* Improve readability on small screens */
      .element-number {
        font-size: 8px;
      }
      
      .comment-badge, .sample-badge {
        font-size: 0.6em;
        padding: 1px 3px;
      }
      
      /* Mobile-friendly forms */
      input[type="text"], input[type="password"], input[type="email"], 
      input[type="number"], input[type="url"], select, textarea {
        font-size: 16px; /* Prevent zoom on iOS */
        padding: 8px;
        border-radius: 4px;
      }
      
      button {
        padding: 10px 15px;
        font-size: 14px;
        border-radius: 4px;
        cursor: pointer;
        touch-action: manipulation;
      }
      
      /* Modal adjustments for mobile */
      #authorInfoModal {
        width: 95vw;
        max-width: 95vw;
        max-height: 85vh;
        padding: 15px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
      
      /* Menu bar improvements */
      #menuBar {
        font-size: 0.8em;
        padding: 8px;
        text-align: left;
      }
      
      #menuBar a {
        display: block;
        margin: 3px 0;
        padding: 2px 0;
      }
      
      /* Chart adjustments */
      #statusChart {
        width: 150px;
        height: 150px;
      }
      
      /* Toast notifications for mobile */
      .toast {
        left: 50%;
        transform: translateX(-50%);
        max-width: 90vw;
        font-size: 14px;
      }
    }
    
    /* Small mobile phones */
    @media screen and (max-width: 480px) {
      .periodic-container td {
        min-width: 40px;
        min-height: 40px;
        font-size: 0.7em;
      }
      
      .sub-block-container td {
        width: 40px;
        height: 40px;
        font-size: 0.7em;
      }
      
      .element-number {
        font-size: 7px;
      }
      
      #elementTitle {
        font-size: 1em;
      }
      
      .details-panel {
        padding: 8px;
      }
      
      #authorInfoModal {
        width: 98vw;
        max-width: 98vw;
        padding: 10px;
      }
      
      /* Stack form elements vertically on very small screens */
      .edit-fields {
        gap: 6px;
      }
      
      textarea {
        height: 60px;
      }
      
      #statusChart {
        width: 120px;
        height: 120px;
      }
    }
    
    /* Touch improvements for all mobile devices */
    @media (hover: none) and (pointer: coarse) {
      .periodic-container td:hover,
      .sub-block-container td:hover {
        background: inherit; /* Remove hover effects on touch devices */
      }
      
      .periodic-container td:active,
      .sub-block-container td:active {
        background: #e0e0e0;
        transform: scale(0.95);
      }
      
      button:hover {
        background: inherit;
      }
      
      button:active {
        transform: scale(0.95);
      }
      
      /* Larger touch targets */
      .comment-badge, .sample-badge {
        min-width: 20px;
        min-height: 20px;
      }
    }
    
    /* High DPI displays */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
      .periodic-container td,
      .sub-block-container td {
        border-width: 0.5px;
      }
      
      #elementTooltip {
        border-width: 0.5px;
      }
    }
    
    /* Landscape orientation on mobile */
    @media screen and (max-width: 768px) and (orientation: landscape) {
      body {
        flex-direction: row;
      }
      
      .details-panel {
        order: 0;
        width: 350px;
      }
      
      .left-column {
        flex: 1;
      }
    }
    
    /* Print styles */
    @media print {
      body {
        background: white !important;
        color: black !important;
      }
      
      .details-panel {
        border: 1px solid black;
        box-shadow: none;
      }
      
      .left-column {
        border: 1px solid black;
        box-shadow: none;
      }
      
      button {
        display: none;
      }
      
      .toast {
        display: none;
      }
      
      #authorInfoModal {
        display: none;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Skip link for accessibility -->
  <a href="#periodicTable" class="skip-link">Skip to periodic table</a>
  
  <!-- LEFT COLUMN -->
  <div class="left-column">
    <div id="topBanner">
      <img src="/static/elementbanner.png" alt="PeriodicChiCubo Banner">
    </div>
    <div id="menuBar">
      <a href="/list">User Directory</a>
      <a href="/profile">Profile Settings</a>
      <a href="/about">About</a>
      <a href="/usage">Usage Guide</a>
      <a href="/media">Media Library</a>
      <a href="/changelog">Changelog</a>
    </div>
    <div id="userStatusBar">Not logged in.</div>
    <div id="topControls" role="main" aria-label="Control Panel">
      <div class="row">
        <label for="usernameInput" class="sr-only">Username</label>
        <input type="text" id="usernameInput" placeholder="Username" aria-label="Username for login" autocomplete="username">
        <label for="passwordInput" class="sr-only">Password</label>
        <input type="password" id="passwordInput" placeholder="Password" aria-label="Password for login" autocomplete="current-password">
        <button id="loginLoadBtn" class="btn-primary" aria-describedby="loginHint">Login &amp; Load</button>
        <button id="saveBtn" class="btn-success" title="Save your collection (Ctrl+S)">Save</button>
        <button id="logoutBtn" class="btn-secondary" style="display:none;">Logout</button>
        <span id="loginHint" class="help-text">To register, input your desired username and password.</span>
      </div>
      <div class="row">
        <label for="viewUsernameInput" class="sr-only">View User</label>
        <input type="text" id="viewUsernameInput" placeholder="View user (public)" aria-label="Username to view public collection">
        <button id="viewBtn" class="btn-primary">View</button>
        <button id="viewOwnerInfoBtn" class="btn-secondary" title="View information about the current collection owner">Author Info</button>
      </div>
      <div class="row">
        <label style="display:flex; align-items:center; margin-right:20px;">
          <input type="checkbox" id="quickStatusCheckbox" style="margin-right:4px;" aria-describedby="quickStatusHelp">
          Quick Status
        </label>
        <label for="quickStatusDropdown" class="sr-only">Quick Status Type</label>
        <select id="quickStatusDropdown" style="margin-right:20px;" aria-label="Select status type for quick assignment">
          <option value="">None</option>
          <option value="Pure">Pure</option>
          <option value="Representative">Representative</option>
          <option value="Alloy">Alloy</option>
          <option value="Wish">Wish</option>
        </select>
        <label style="display:flex; align-items:center; margin-right:20px;">
          <input type="checkbox" id="galleryViewCheckbox" style="margin-right:4px;" aria-describedby="galleryHelp">
          Gallery View
        </label>
        <span id="quickStatusHelp" class="sr-only">Enable to quickly assign status to elements by clicking</span>
        <span id="galleryHelp" class="sr-only">Toggle between table and gallery view of elements</span>
      </div>
    </div>
    <div class="periodic-container" role="region" aria-label="Periodic Table of Elements">
      <!-- Toggle Handle for sticky mode -->
      <button id="toggleStickyBtn" title="Toggle sticky table mode">Stick Table</button>
      <!-- Main Periodic Table -->
      <table id="periodicTable" role="table" aria-label="Periodic Table of Chemical Elements"></table>
      <div class="sub-block-container">
        <strong>Lanthanides (La–Lu)</strong>
        <table id="lanthanideTable"></table>
      </div>
      <div class="sub-block-container">
        <strong>Actinides (Ac–Lr)</strong>
        <table id="actinideTable"></table>
      </div>
      <div id="elementTooltip"></div>
      <canvas id="statusChart"></canvas>
    </div>
    <div id="counters">Counters here...</div>
  </div>
  <!-- RIGHT COLUMN: DETAILS PANEL -->
  <div class="details-panel edit-mode" id="detailsPanel">
    <img src="/static/details.png" style="max-width:100%;" alt="Element Details Banner">
    <div id="elementTitle"></div>
    <div class="edit-fields" id="editFields">
      <label>Status:</label>
      <select id="statusSelect">
        <option value="">None</option>
        <option value="Pure">Pure</option>
        <option value="Representative">Representative</option>
        <option value="Alloy">Alloy</option>
        <option value="Wish">Wish</option>
      </select>
      <label>Quantity (g):</label>
      <input type="number" id="quantityInput" step="0.001" min="0" style="width:100%;">
      <label>Purity (%):</label>
      <input type="number" id="purityInput" step="0.01" min="0" max="100" style="width:100%;">
      <label>Description:</label>
      <textarea id="descArea"></textarea>
      <label>Image URL:</label>
      <input type="text" id="imgUrlInput" placeholder="https://example.com/image.jpg">
      <button id="setUrlBtn">Set URL</button>
      <label>Or upload an Image (max ~2MB):</label>
      <!-- Added name="image" attribute -->
      <input type="file" id="imgFileInput" name="image">
      <button id="uploadBtn">Upload</button>
    </div>
    <!-- Wrap preview image in an anchor so it is clickable -->
    <a id="previewLink" href="#" target="_blank" style="display:none;">
      <img id="previewImg" alt="No image">
    </a>
    <!-- SAMPLES SECTION -->
    <div id="samplesSection">
      <h3>Samples</h3>
      <div id="samplesList"></div>
      <!-- When viewing a public collection, hide sample add tools -->
      <div id="sampleTools">
        <button id="showAddSampleBtn">Add Sample</button>
        <div id="addSampleForm" style="display:none;">
          <label>Sample Status:</label>
          <select id="sampleStatusSelect">
            <option value="">None</option>
            <option value="Pure">Pure</option>
            <option value="Representative">Representative</option>
            <option value="Alloy">Alloy</option>
            <option value="Wish">Wish</option>
          </select>
          <label>Sample Description:</label>
          <textarea id="sampleDesc"></textarea>
          <label>Sample Image URL:</label>
          <input type="text" id="sampleImgUrl" placeholder="https://example.com/sample.jpg">
          <label>Or upload Sample File:</label>
          <!-- Added name="image" attribute -->
          <input type="file" id="sampleImgFile" name="image">
          <button id="uploadSampleBtn">Upload Sample File</button>
          <label>Quantity (g):</label>
          <input type="number" id="sampleQuantity" step="0.001" min="0">
          <label>Purity (%):</label>
          <input type="number" id="samplePurity" step="0.01" min="0" max="100">
          <button id="submitSampleBtn">Submit Sample</button>
          <button id="cancelSampleBtn">Cancel</button>
        </div>
      </div>
    </div>
    <div id="commentsContainer"></div>
    <!-- NEW: Comment Section with inline login UI -->
    <div class="add-comment-section" id="addCommentSection">
      <!-- This section will show either the login form or the comment posting UI -->
      <div id="commentLoginSection" style="display:none;">
         <label>Username:</label>
         <input type="text" id="commentLoginUsername" placeholder="Username">
         <label>Password:</label>
         <input type="password" id="commentLoginPassword" placeholder="Password">
         <button id="commentLoginBtn">Login</button>
      </div>
      <div id="commentPostSection" style="display:none;">
         <p id="commentingAs"></p>
         <label for="commentInput"><strong>Add a comment:</strong></label>
         <textarea id="commentInput" placeholder="Your comment..."></textarea>
         <button id="postCommentBtn">Post Comment</button>
      </div>
      <div style="clear:both;"></div>
    </div>
  </div>
  <!-- AUTHOR INFO MODAL (used for both clicking comment usernames and Author Info) -->
  <div id="authorInfoModal">
    <div id="authorInfoContent"></div>
    <button id="authorInfoClose" class="btn-secondary">Close</button>
  </div>
  
  <!-- Toast notification container -->
  <div id="toastContainer"></div>
  <script>
    /**************************************************************
     * UTILITY FUNCTIONS FOR ENHANCED UX
     **************************************************************/
    
    // Toast notification system
    function showToast(message, type = 'info', duration = 3000) {
      const container = document.getElementById('toastContainer');
      if (!container) return;
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      
      container.appendChild(toast);
      
      // Trigger animation
      setTimeout(() => toast.classList.add('show'), 100);
      
      // Auto remove
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => container.removeChild(toast), 300);
      }, duration);
    }
    
    // Loading state for buttons
    function setButtonLoading(button, loading) {
      if (loading) {
        button.disabled = true;
        button.classList.add('loading');
        button.dataset.originalText = button.textContent;
        button.textContent = 'Loading...';
      } else {
        button.disabled = false;
        button.classList.remove('loading');
        button.textContent = button.dataset.originalText || button.textContent;
      }
    }
    
    // Enhanced alert replacement
    function showAlert(message, type = 'info') {
      showToast(message, type, 4000);
    }
    
    // Debounce utility for performance
    function debounce(func, wait, immediate) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          timeout = null;
          if (!immediate) func(...args);
        };
        const callNow = immediate && !timeout;
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
        if (callNow) func(...args);
      };
    }
    
    // Performance monitoring
    function measurePerformance(name, fn) {
      return function(...args) {
        const start = performance.now();
        const result = fn.apply(this, args);
        const end = performance.now();
        console.debug(`${name} took ${end - start} milliseconds`);
        return result;
      };
    }
    
    // Add selected state to periodic table cells
    let selectedCell = null;
    function selectCell(cell) {
      if (selectedCell) {
        selectedCell.classList.remove('selected');
      }
      selectedCell = cell;
      if (cell) {
        cell.classList.add('selected');
      }
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Ctrl/Cmd + S to save
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        if (document.getElementById('saveBtn').style.display !== 'none') {
          document.getElementById('saveBtn').click();
        }
      }
      // Escape to close modals
      if (e.key === 'Escape') {
        const modal = document.getElementById('authorInfoModal');
        if (modal && modal.style.display === 'block') {
          modal.style.display = 'none';
        }
      }
    });
    
    /**************************************************************
     * 1) STATIC ELEMENTS DATA
     * (The complete elementsData array is omitted for brevity)
     **************************************************************/

      const elementsData = [
        {
          atomicNumber: 1,
          symbol: "H",
          name: "Hydrogen",
          category: "nonmetal",
          group: 1,
          period: 1,
          atomicMass: 1.008,
          briefDesc: "Lightest element, highly reactive nonmetal"
        },
        {
          atomicNumber: 2,
          symbol: "He",
          name: "Helium",
          category: "noble gas",
          group: 18,
          period: 1,
          atomicMass: 4.002602,
          briefDesc: "Colorless, odorless noble gas used in balloons"
        },
        {
          atomicNumber: 3,
          symbol: "Li",
          name: "Lithium",
          category: "alkali metal",
          group: 1,
          period: 2,
          atomicMass: 6.94,
          briefDesc: "Soft, silvery metal, lightest metal"
        },
        {
          atomicNumber: 4,
          symbol: "Be",
          name: "Beryllium",
          category: "alkaline earth metal",
          group: 2,
          period: 2,
          atomicMass: 9.0121831,
          briefDesc: "Hard, gray metal, toxic in some forms"
        },
        {
          atomicNumber: 5,
          symbol: "B",
          name: "Boron",
          category: "metalloid",
          group: 13,
          period: 2,
          atomicMass: 10.81,
          briefDesc: "Brittle, black metalloid used in semiconductors"
        },
        {
          atomicNumber: 6,
          symbol: "C",
          name: "Carbon",
          category: "nonmetal",
          group: 14,
          period: 2,
          atomicMass: 12.011,
          briefDesc: "Nonmetal with allotropes like diamond & graphite"
        },
        {
          atomicNumber: 7,
          symbol: "N",
          name: "Nitrogen",
          category: "nonmetal",
          group: 15,
          period: 2,
          atomicMass: 14.007,
          briefDesc: "Colorless gas, ~78% of Earth's atmosphere"
        },
        {
          atomicNumber: 8,
          symbol: "O",
          name: "Oxygen",
          category: "nonmetal",
          group: 16,
          period: 2,
          atomicMass: 15.999,
          briefDesc: "Colorless gas essential for aerobic life"
        },
        {
          atomicNumber: 9,
          symbol: "F",
          name: "Fluorine",
          category: "halogen",
          group: 17,
          period: 2,
          atomicMass: 18.998403163,
          briefDesc: "Pale yellow, highly reactive gas"
        },
        {
          atomicNumber: 10,
          symbol: "Ne",
          name: "Neon",
          category: "noble gas",
          group: 18,
          period: 2,
          atomicMass: 20.1797,
          briefDesc: "Inert gas used in neon signs"
        },
        {
          atomicNumber: 11,
          symbol: "Na",
          name: "Sodium",
          category: "alkali metal",
          group: 1,
          period: 3,
          atomicMass: 22.98976928,
          briefDesc: "Soft, reactive metal that tarnishes quickly"
        },
        {
          atomicNumber: 12,
          symbol: "Mg",
          name: "Magnesium",
          category: "alkaline earth metal",
          group: 2,
          period: 3,
          atomicMass: 24.305,
          briefDesc: "Light metal, burns with bright white flame"
        },
        {
          atomicNumber: 13,
          symbol: "Al",
          name: "Aluminum",
          category: "post-transition metal",
          group: 13,
          period: 3,
          atomicMass: 26.9815385,
          briefDesc: "Silvery metal used in aircraft, packaging"
        },
        {
          atomicNumber: 14,
          symbol: "Si",
          name: "Silicon",
          category: "metalloid",
          group: 14,
          period: 3,
          atomicMass: 28.085,
          briefDesc: "Semiconductor metalloid used in electronics"
        },
        {
          atomicNumber: 15,
          symbol: "P",
          name: "Phosphorus",
          category: "nonmetal",
          group: 15,
          period: 3,
          atomicMass: 30.974,
          briefDesc: "Multiple allotropes; vital in biology"
        },
        {
          atomicNumber: 16,
          symbol: "S",
          name: "Sulfur",
          category: "nonmetal",
          group: 16,
          period: 3,
          atomicMass: 32.06,
          briefDesc: "Yellow nonmetal used in sulfuric acid"
        },
        {
          atomicNumber: 17,
          symbol: "Cl",
          name: "Chlorine",
          category: "halogen",
          group: 17,
          period: 3,
          atomicMass: 35.45,
          briefDesc: "Greenish-yellow, reactive gas; used as disinfectant"
        },
        {
          atomicNumber: 18,
          symbol: "Ar",
          name: "Argon",
          category: "noble gas",
          group: 18,
          period: 3,
          atomicMass: 39.948,
          briefDesc: "Inert, colorless gas used in lighting"
        },
        {
          atomicNumber: 19,
          symbol: "K",
          name: "Potassium",
          category: "alkali metal",
          group: 1,
          period: 4,
          atomicMass: 39.0983,
          briefDesc: "Soft, reactive metal essential to biology"
        },
        {
          atomicNumber: 20,
          symbol: "Ca",
          name: "Calcium",
          category: "alkaline earth metal",
          group: 2,
          period: 4,
          atomicMass: 40.078,
          briefDesc: "Vital for bones, silvery metal"
        },
        {
          atomicNumber: 21,
          symbol: "Sc",
          name: "Scandium",
          category: "transition metal",
          group: 3,
          period: 4,
          atomicMass: 44.955908,
          briefDesc: "Light, silvery metal used in alloys"
        },
        {
          atomicNumber: 22,
          symbol: "Ti",
          name: "Titanium",
          category: "transition metal",
          group: 4,
          period: 4,
          atomicMass: 47.867,
          briefDesc: "Strong, light, corrosion-resistant metal"
        },
        {
          atomicNumber: 23,
          symbol: "V",
          name: "Vanadium",
          category: "transition metal",
          group: 5,
          period: 4,
          atomicMass: 50.9415,
          briefDesc: "Used to strengthen steel alloys"
        },
        {
          atomicNumber: 24,
          symbol: "Cr",
          name: "Chromium",
          category: "transition metal",
          group: 6,
          period: 4,
          atomicMass: 51.9961,
          briefDesc: "Lustrous, hard metal for stainless steel"
        },
        {
          atomicNumber: 25,
          symbol: "Mn",
          name: "Manganese",
          category: "transition metal",
          group: 7,
          period: 4,
          atomicMass: 54.938044,
          briefDesc: "Hard, brittle metal used in steel"
        },
        {
          atomicNumber: 26,
          symbol: "Fe",
          name: "Iron",
          category: "transition metal",
          group: 8,
          period: 4,
          atomicMass: 55.845,
          briefDesc: "Most used metal, basis of steel"
        },
        {
          atomicNumber: 27,
          symbol: "Co",
          name: "Cobalt",
          category: "transition metal",
          group: 9,
          period: 4,
          atomicMass: 58.933194,
          briefDesc: "Hard, lustrous, silver-gray metal"
        },
        {
          atomicNumber: 28,
          symbol: "Ni",
          name: "Nickel",
          category: "transition metal",
          group: 10,
          period: 4,
          atomicMass: 58.6934,
          briefDesc: "Silvery metal used in coins, alloys"
        },
        {
          atomicNumber: 29,
          symbol: "Cu",
          name: "Copper",
          category: "transition metal",
          group: 11,
          period: 4,
          atomicMass: 63.546,
          briefDesc: "Reddish metal, excellent electrical conductor"
        },
        {
          atomicNumber: 30,
          symbol: "Zn",
          name: "Zinc",
          category: "transition metal",
          group: 12,
          period: 4,
          atomicMass: 65.38,
          briefDesc: "Bluish-silver metal used to galvanize steel"
        },
        {
          atomicNumber: 31,
          symbol: "Ga",
          name: "Gallium",
          category: "post-transition metal",
          group: 13,
          period: 4,
          atomicMass: 69.723,
          briefDesc: "Soft metal melting near room temp"
        },
        {
          atomicNumber: 32,
          symbol: "Ge",
          name: "Germanium",
          category: "metalloid",
          group: 14,
          period: 4,
          atomicMass: 72.63,
          briefDesc: "Grayish-white metalloid for semiconductors"
        },
        {
          atomicNumber: 33,
          symbol: "As",
          name: "Arsenic",
          category: "metalloid",
          group: 15,
          period: 4,
          atomicMass: 74.921595,
          briefDesc: "Poisonous metalloid with many allotropes"
        },
        {
          atomicNumber: 34,
          symbol: "Se",
          name: "Selenium",
          category: "nonmetal",
          group: 16,
          period: 4,
          atomicMass: 78.971,
          briefDesc: "Nonmetal used in photocopiers, glass"
        },
        {
          atomicNumber: 35,
          symbol: "Br",
          name: "Bromine",
          category: "halogen",
          group: 17,
          period: 4,
          atomicMass: 79.904,
          briefDesc: "Reddish-brown liquid halogen"
        },
        {
          atomicNumber: 36,
          symbol: "Kr",
          name: "Krypton",
          category: "noble gas",
          group: 18,
          period: 4,
          atomicMass: 83.798,
          briefDesc: "Colorless noble gas for lighting"
        },
        {
          atomicNumber: 37,
          symbol: "Rb",
          name: "Rubidium",
          category: "alkali metal",
          group: 1,
          period: 5,
          atomicMass: 85.4678,
          briefDesc: "Very soft, highly reactive metal"
        },
        {
          atomicNumber: 38,
          symbol: "Sr",
          name: "Strontium",
          category: "alkaline earth metal",
          group: 2,
          period: 5,
          atomicMass: 87.62,
          briefDesc: "Silvery metal used in red fireworks"
        },
        {
          atomicNumber: 39,
          symbol: "Y",
          name: "Yttrium",
          category: "transition metal",
          group: 3,
          period: 5,
          atomicMass: 88.90584,
          briefDesc: "Silvery metal used in phosphors"
        },
        {
          atomicNumber: 40,
          symbol: "Zr",
          name: "Zirconium",
          category: "transition metal",
          group: 4,
          period: 5,
          atomicMass: 91.224,
          briefDesc: "Corrosion-resistant metal for nuclear reactors"
        },
        {
          atomicNumber: 41,
          symbol: "Nb",
          name: "Niobium",
          category: "transition metal",
          group: 5,
          period: 5,
          atomicMass: 92.90637,
          briefDesc: "Used in superconducting materials"
        },
        {
          atomicNumber: 42,
          symbol: "Mo",
          name: "Molybdenum",
          category: "transition metal",
          group: 6,
          period: 5,
          atomicMass: 95.95,
          briefDesc: "Hard, silvery metal for steel alloys"
        },
        {
          atomicNumber: 43,
          symbol: "Tc",
          name: "Technetium",
          category: "transition metal",
          group: 7,
          period: 5,
          atomicMass: 98,
          briefDesc: "Radioactive, first artificially made element"
        },
        {
          atomicNumber: 44,
          symbol: "Ru",
          name: "Ruthenium",
          category: "transition metal",
          group: 8,
          period: 5,
          atomicMass: 101.07,
          briefDesc: "Hard, silvery-white transition metal"
        },
        {
          atomicNumber: 45,
          symbol: "Rh",
          name: "Rhodium",
          category: "transition metal",
          group: 9,
          period: 5,
          atomicMass: 102.90550,
          briefDesc: "Highly reflective metal, used in plating"
        },
        {
          atomicNumber: 46,
          symbol: "Pd",
          name: "Palladium",
          category: "transition metal",
          group: 10,
          period: 5,
          atomicMass: 106.42,
          briefDesc: "Rare, lustrous metal in catalytic converters"
        },
        {
          atomicNumber: 47,
          symbol: "Ag",
          name: "Silver",
          category: "transition metal",
          group: 11,
          period: 5,
          atomicMass: 107.8682,
          briefDesc: "Best electrical conductor, lustrous"
        },
        {
          atomicNumber: 48,
          symbol: "Cd",
          name: "Cadmium",
          category: "transition metal",
          group: 12,
          period: 5,
          atomicMass: 112.414,
          briefDesc: "Bluish-white metal, toxic"
        },
        {
          atomicNumber: 49,
          symbol: "In",
          name: "Indium",
          category: "post-transition metal",
          group: 13,
          period: 5,
          atomicMass: 114.818,
          briefDesc: "Soft, malleable, used in LCDs"
        },
        {
          atomicNumber: 50,
          symbol: "Sn",
          name: "Tin",
          category: "post-transition metal",
          group: 14,
          period: 5,
          atomicMass: 118.71,
          briefDesc: "Silvery metal historically used in cans"
        },
        {
          atomicNumber: 51,
          symbol: "Sb",
          name: "Antimony",
          category: "metalloid",
          group: 15,
          period: 5,
          atomicMass: 121.76,
          briefDesc: "Brittle metalloid used in flame retardants"
        },
        {
          atomicNumber: 52,
          symbol: "Te",
          name: "Tellurium",
          category: "metalloid",
          group: 16,
          period: 5,
          atomicMass: 127.6,
          briefDesc: "Brittle, silvery metalloid in semiconductors"
        },
        {
          atomicNumber: 53,
          symbol: "I",
          name: "Iodine",
          category: "halogen",
          group: 17,
          period: 5,
          atomicMass: 126.90447,
          briefDesc: "Purple-black solid halogen, essential nutrient"
        },
        {
          atomicNumber: 54,
          symbol: "Xe",
          name: "Xenon",
          category: "noble gas",
          group: 18,
          period: 5,
          atomicMass: 131.293,
          briefDesc: "Heavy, colorless noble gas, used in flash lamps"
        },
        {
          atomicNumber: 55,
          symbol: "Cs",
          name: "Cesium",
          category: "alkali metal",
          group: 1,
          period: 6,
          atomicMass: 132.90545196,
          briefDesc: "Soft, golden metal, highly reactive"
        },
        {
          atomicNumber: 56,
          symbol: "Ba",
          name: "Barium",
          category: "alkaline earth metal",
          group: 2,
          period: 6,
          atomicMass: 137.327,
          briefDesc: "Silvery metal used in X-ray contrast agents"
        },
        {
          atomicNumber: 57,
          symbol: "La",
          name: "Lanthanum",
          category: "lanthanide",
          group: 3,
          period: 6,
          atomicMass: 138.90547,
          briefDesc: "Soft, ductile metal, starts lanthanide series"
        },
        {
          atomicNumber: 58,
          symbol: "Ce",
          name: "Cerium",
          category: "lanthanide",
          group: 3,
          period: 6,
          atomicMass: 140.116,
          briefDesc: "Most abundant lanthanide, used in converters"
        },
        {
          atomicNumber: 59,
          symbol: "Pr",
          name: "Praseodymium",
          category: "lanthanide",
          group: 3,
          period: 6,
          atomicMass: 140.90766,
          briefDesc: "Soft, silvery lanthanide used in magnets"
        },
        {
          atomicNumber: 60,
          symbol: "Nd",
          name: "Neodymium",
          category: "lanthanide",
          group: 3,
          period: 6,
          atomicMass: 144.242,
          briefDesc: "Used in powerful rare-earth magnets"
        },
        {
          atomicNumber: 61,
          symbol: "Pm",
          name: "Promethium",
          category: "lanthanide",
          group: 3,
          period: 6,
          atomicMass: 145,
          briefDesc: "Radioactive, no stable isotopes"
        },
        {
          atomicNumber: 62,
          symbol: "Sm",
          name: "Samarium",
          category: "lanthanide",
          group: 3,
          period: 6,
          atomicMass: 150.36,
          briefDesc: "Used in magnets and nuclear reactors"
        },
        {
          atomicNumber: 63,
          symbol: "Eu",
          name: "Europium",
          category: "lanthanide",
          group: 3,
          period: 6,
          atomicMass: 151.964,
          briefDesc: "Most reactive lanthanide, used in phosphors"
        },
        {
          atomicNumber: 64,
          symbol: "Gd",
          name: "Gadolinium",
          category: "lanthanide",
          group: 3,
          period: 6,
          atomicMass: 157.25,
          briefDesc: "Used in MRI contrast, has special magnetic properties"
        },
        {
          atomicNumber: 65,
          symbol: "Tb",
          name: "Terbium",
          category: "lanthanide",
          group: 3,
          period: 6,
          atomicMass: 158.925354,
          briefDesc: "Used in green phosphors & devices"
        },
        {
          atomicNumber: 66,
          symbol: "Dy",
          name: "Dysprosium",
          category: "lanthanide",
          group: 3,
          period: 6,
          atomicMass: 162.5,
          briefDesc: "Silvery metal for lasers, magnets"
        },
        {
          atomicNumber: 67,
          symbol: "Ho",
          name: "Holmium",
          category: "lanthanide",
          group: 3,
          period: 6,
          atomicMass: 164.930328,
          briefDesc: "Used in nuclear reactors & special alloys"
        },
        {
          atomicNumber: 68,
          symbol: "Er",
          name: "Erbium",
          category: "lanthanide",
          group: 3,
          period: 6,
          atomicMass: 167.259,
          briefDesc: "Used in optical fibers & amplifiers"
        },
        {
          atomicNumber: 69,
          symbol: "Tm",
          name: "Thulium",
          category: "lanthanide",
          group: 3,
          period: 6,
          atomicMass: 168.934218,
          briefDesc: "Rare, used in some lasers"
        },
        {
          atomicNumber: 70,
          symbol: "Yb",
          name: "Ytterbium",
          category: "lanthanide",
          group: 3,
          period: 6,
          atomicMass: 173.045,
          briefDesc: "Soft, silvery metal used in some steels"
        },
        {
          atomicNumber: 71,
          symbol: "Lu",
          name: "Lutetium",
          category: "lanthanide",
          group: 3,
          period: 6,
          atomicMass: 174.9668,
          briefDesc: "Hard, silvery-white metal, end of lanthanides"
        },
        {
          atomicNumber: 72,
          symbol: "Hf",
          name: "Hafnium",
          category: "transition metal",
          group: 4,
          period: 6,
          atomicMass: 178.49,
          briefDesc: "Used in nuclear control rods, very corrosion-resistant"
        },
        {
          atomicNumber: 73,
          symbol: "Ta",
          name: "Tantalum",
          category: "transition metal",
          group: 5,
          period: 6,
          atomicMass: 180.94788,
          briefDesc: "Blue-gray metal, highly corrosion-resistant"
        },
        {
          atomicNumber: 74,
          symbol: "W",
          name: "Tungsten",
          category: "transition metal",
          group: 6,
          period: 6,
          atomicMass: 183.84,
          briefDesc: "Highest melting point of all elements"
        },
        {
          atomicNumber: 75,
          symbol: "Re",
          name: "Rhenium",
          category: "transition metal",
          group: 7,
          period: 6,
          atomicMass: 186.207,
          briefDesc: "Rare metal used in superalloys"
        },
        {
          atomicNumber: 76,
          symbol: "Os",
          name: "Osmium",
          category: "transition metal",
          group: 8,
          period: 6,
          atomicMass: 190.23,
          briefDesc: "Densest naturally occurring element"
        },
        {
          atomicNumber: 77,
          symbol: "Ir",
          name: "Iridium",
          category: "transition metal",
          group: 9,
          period: 6,
          atomicMass: 192.217,
          briefDesc: "Very hard, brittle metal with high melting point"
        },
        {
          atomicNumber: 78,
          symbol: "Pt",
          name: "Platinum",
          category: "transition metal",
          group: 10,
          period: 6,
          atomicMass: 195.084,
          briefDesc: "Precious, dense, malleable metal for catalysts"
        },
        {
          atomicNumber: 79,
          symbol: "Au",
          name: "Gold",
          category: "transition metal",
          group: 11,
          period: 6,
          atomicMass: 196.966569,
          briefDesc: "Soft, yellow metal, highly valued precious metal"
        },
        {
          atomicNumber: 80,
          symbol: "Hg",
          name: "Mercury",
          category: "transition metal",
          group: 12,
          period: 6,
          atomicMass: 200.592,
          briefDesc: "Silvery metal, liquid at room temperature"
        },
        {
          atomicNumber: 81,
          symbol: "Tl",
          name: "Thallium",
          category: "post-transition metal",
          group: 13,
          period: 6,
          atomicMass: 204.38,
          briefDesc: "Soft, gray metal, highly toxic"
        },
        {
          atomicNumber: 82,
          symbol: "Pb",
          name: "Lead",
          category: "post-transition metal",
          group: 14,
          period: 6,
          atomicMass: 207.2,
          briefDesc: "Soft, malleable metal used in batteries"
        },
        {
          atomicNumber: 83,
          symbol: "Bi",
          name: "Bismuth",
          category: "post-transition metal",
          group: 15,
          period: 6,
          atomicMass: 208.98040,
          briefDesc: "Brittle metal, low toxicity, used in meds"
        },
        {
          atomicNumber: 84,
          symbol: "Po",
          name: "Polonium",
          category: "metalloid",
          group: 16,
          period: 6,
          atomicMass: 209,
          briefDesc: "Radioactive metalloid discovered by Curie"
        },
        {
          atomicNumber: 85,
          symbol: "At",
          name: "Astatine",
          category: "halogen",
          group: 17,
          period: 6,
          atomicMass: 210,
          briefDesc: "Rare, radioactive halogen"
        },
        {
          atomicNumber: 86,
          symbol: "Rn",
          name: "Radon",
          category: "noble gas",
          group: 18,
          period: 6,
          atomicMass: 222,
          briefDesc: "Radioactive, colorless noble gas"
        },
        {
          atomicNumber: 87,
          symbol: "Fr",
          name: "Francium",
          category: "alkali metal",
          group: 1,
          period: 7,
          atomicMass: 223,
          briefDesc: "Extremely reactive, radioactive alkali metal"
        },
        {
          atomicNumber: 88,
          symbol: "Ra",
          name: "Radium",
          category: "alkaline earth metal",
          group: 2,
          period: 7,
          atomicMass: 226,
          briefDesc: "Radioactive, glows faintly in the dark"
        },
        {
          atomicNumber: 89,
          symbol: "Ac",
          name: "Actinium",
          category: "actinide",
          group: 3,
          period: 7,
          atomicMass: 227,
          briefDesc: "Radioactive, starts the actinide series"
        },
        {
          atomicNumber: 90,
          symbol: "Th",
          name: "Thorium",
          category: "actinide",
          group: 3,
          period: 7,
          atomicMass: 232.0377,
          briefDesc: "Potential nuclear fuel, slightly radioactive"
        },
        {
          atomicNumber: 91,
          symbol: "Pa",
          name: "Protactinium",
          category: "actinide",
          group: 3,
          period: 7,
          atomicMass: 231.03588,
          briefDesc: "Rare, radioactive actinide"
        },
        {
          atomicNumber: 92,
          symbol: "U",
          name: "Uranium",
          category: "actinide",
          group: 3,
          period: 7,
          atomicMass: 238.02891,
          briefDesc: "Radioactive, used in nuclear power & weapons"
        },
        {
          atomicNumber: 93,
          symbol: "Np",
          name: "Neptunium",
          category: "actinide",
          group: 3,
          period: 7,
          atomicMass: 237,
          briefDesc: "Transuranic, radioactive actinide"
        },
        {
          atomicNumber: 94,
          symbol: "Pu",
          name: "Plutonium",
          category: "actinide",
          group: 3,
          period: 7,
          atomicMass: 244,
          briefDesc: "Transuranic, radioactive, used in nuclear bombs"
        },
        {
          atomicNumber: 95,
          symbol: "Am",
          name: "Americium",
          category: "actinide",
          group: 3,
          period: 7,
          atomicMass: 243,
          briefDesc: "Radioactive, used in smoke detectors"
        },
        {
          atomicNumber: 96,
          symbol: "Cm",
          name: "Curium",
          category: "actinide",
          group: 3,
          period: 7,
          atomicMass: 247,
          briefDesc: "Transuranic, radioactive metal"
        },
        {
          atomicNumber: 97,
          symbol: "Bk",
          name: "Berkelium",
          category: "actinide",
          group: 3,
          period: 7,
          atomicMass: 247,
          briefDesc: "Transuranic, synthetic radioactive actinide"
        },
        {
          atomicNumber: 98,
          symbol: "Cf",
          name: "Californium",
          category: "actinide",
          group: 3,
          period: 7,
          atomicMass: 251,
          briefDesc: "Transuranic, used to start nuclear reactors"
        },
        {
          atomicNumber: 99,
          symbol: "Es",
          name: "Einsteinium",
          category: "actinide",
          group: 3,
          period: 7,
          atomicMass: 252,
          briefDesc: "Synthetic, radioactive metal"
        },
        {
          atomicNumber: 100,
          symbol: "Fm",
          name: "Fermium",
          category: "actinide",
          group: 3,
          period: 7,
          atomicMass: 257,
          briefDesc: "Synthetic, radioactive actinide"
        },
        {
          atomicNumber: 101,
          symbol: "Md",
          name: "Mendelevium",
          category: "actinide",
          group: 3,
          period: 7,
          atomicMass: 258,
          briefDesc: "Synthetic, radioactive actinide"
        },
        {
          atomicNumber: 102,
          symbol: "No",
          name: "Nobelium",
          category: "actinide",
          group: 3,
          period: 7,
          atomicMass: 259,
          briefDesc: "Synthetic, radioactive actinide"
        },
        {
          atomicNumber: 103,
          symbol: "Lr",
          name: "Lawrencium",
          category: "actinide",
          group: 3,
          period: 7,
          atomicMass: 266,
          briefDesc: "Synthetic, radioactive metal"
        },
        {
          atomicNumber: 104,
          symbol: "Rf",
          name: "Rutherfordium",
          category: "transition metal",
          group: 4,
          period: 7,
          atomicMass: 267,
          briefDesc: "Synthetic, radioactive transition metal"
        },
        {
          atomicNumber: 105,
          symbol: "Db",
          name: "Dubnium",
          category: "transition metal",
          group: 5,
          period: 7,
          atomicMass: 268,
          briefDesc: "Synthetic, radioactive transition metal"
        },
        {
          atomicNumber: 106,
          symbol: "Sg",
          name: "Seaborgium",
          category: "transition metal",
          group: 6,
          period: 7,
          atomicMass: 269,
          briefDesc: "Synthetic, radioactive transition metal"
        },
        {
          atomicNumber: 107,
          symbol: "Bh",
          name: "Bohrium",
          category: "transition metal",
          group: 7,
          period: 7,
          atomicMass: 270,
          briefDesc: "Synthetic, radioactive transition metal"
        },
        {
          atomicNumber: 108,
          symbol: "Hs",
          name: "Hassium",
          category: "transition metal",
          group: 8,
          period: 7,
          atomicMass: 269,
          briefDesc: "Synthetic, radioactive transition metal"
        },
        {
          atomicNumber: 109,
          symbol: "Mt",
          name: "Meitnerium",
          category: "transition metal",
          group: 9,
          period: 7,
          atomicMass: 278,
          briefDesc: "Synthetic, radioactive transition metal"
        },
        {
          atomicNumber: 110,
          symbol: "Ds",
          name: "Darmstadtium",
          category: "transition metal",
          group: 10,
          period: 7,
          atomicMass: 281,
          briefDesc: "Synthetic, radioactive transition metal"
        },
        {
          atomicNumber: 111,
          symbol: "Rg",
          name: "Roentgenium",
          category: "transition metal",
          group: 11,
          period: 7,
          atomicMass: 282,
          briefDesc: "Synthetic, radioactive transition metal"
        },
        {
          atomicNumber: 112,
          symbol: "Cn",
          name: "Copernicium",
          category: "post-transition metal",
          group: 12,
          period: 7,
          atomicMass: 285,
          briefDesc: "Synthetic, radioactive post-transition metal"
        },
        {
          atomicNumber: 113,
          symbol: "Nh",
          name: "Nihonium",
          category: "post-transition metal",
          group: 13,
          period: 7,
          atomicMass: 286,
          briefDesc: "Synthetic, radioactive post-transition metal"
        },
        {
          atomicNumber: 114,
          symbol: "Fl",
          name: "Flerovium",
          category: "post-transition metal",
          group: 14,
          period: 7,
          atomicMass: 289,
          briefDesc: "Synthetic, radioactive post-transition metal"
        },
        {
          atomicNumber: 115,
          symbol: "Mc",
          name: "Moscovium",
          category: "post-transition metal",
          group: 15,
          period: 7,
          atomicMass: 289,
          briefDesc: "Synthetic, radioactive post-transition metal"
        },
        {
          atomicNumber: 116,
          symbol: "Lv",
          name: "Livermorium",
          category: "post-transition metal",
          group: 16,
          period: 7,
          atomicMass: 293,
          briefDesc: "Synthetic, radioactive post-transition metal"
        },
        {
          atomicNumber: 117,
          symbol: "Ts",
          name: "Tennessine",
          category: "halogen",
          group: 17,
          period: 7,
          atomicMass: 294,
          briefDesc: "Synthetic, radioactive halogen"
        },
        {
          atomicNumber: 118,
          symbol: "Og",
          name: "Oganesson",
          category: "noble gas",
          group: 18,
          period: 7,
          atomicMass: 294,
          briefDesc: "Synthetic, heaviest noble gas known"
        }
      ];

    /**************************************************************
     * 2) RUNTIME VARIABLES
     **************************************************************/
    let isLoggedIn      = false;
    let loggedInUser    = null;
    let isViewingPublic = false;
    let viewedUser      = null;
    let elementDataStatus = {}; // statuses for elements
    let currentSymbol   = null;
    let quickStatusMode = false;
    let quickStatusValue= "";
    let myChart         = null;
    let commentCounts   = {};
    let sampleCounts    = {};
    let galleryMode     = false;
    const userStatusBar = document.getElementById("userStatusBar");
    const logoutBtn     = document.getElementById("logoutBtn");
    const detailsPanel  = document.getElementById("detailsPanel");
    // NEW GLOBAL VARIABLES FOR SAMPLE RECORDS
    let samplesData = {};
    let editingSampleId = null;

    /**************************************************************
     * 3) BUILD THE MAIN TABLE & SUBTABLES
     **************************************************************/
    function buildMainTable(){
      const table = document.getElementById("periodicTable");
      table.innerHTML = "";
      const maxPeriod = 7, maxGroup = 18;
      for(let p = 1; p <= maxPeriod; p++){
        const tr = document.createElement("tr");
        for(let g = 1; g <= maxGroup; g++){
          const td = document.createElement("td");
          const el = elementsData.find(e => e.period === p && e.group === g);
          if(el) {
            populateCell(td, el);
          } else {
            td.style.background = '#f8f8f8';
            td.style.cursor = 'default';
          }
          tr.appendChild(td);
        }
        table.appendChild(tr);
      }
    }
    function buildLanthanideTable(){
      const lt = document.getElementById("lanthanideTable");
      lt.innerHTML = "";
      const row = document.createElement("tr");
      for(let z = 57; z <= 71; z++){
        const td = document.createElement("td");
        const el = elementsData.find(e => e.atomicNumber === z);
        if(el) populateCell(td, el);
        row.appendChild(td);
      }
      lt.appendChild(row);
    }
    function buildActinideTable(){
      const at = document.getElementById("actinideTable");
      at.innerHTML = "";
      const row = document.createElement("tr");
      for(let z = 89; z <= 103; z++){
        const td = document.createElement("td");
        const el = elementsData.find(e => e.atomicNumber === z);
        if(el) populateCell(td, el);
        row.appendChild(td);
      }
      at.appendChild(row);
    }
    function getCategoryOutlineColor(cat){
      switch(cat){
        case 'alkali metal': return '#FFB347';
        case 'alkaline earth metal': return '#FFDB58';
        case 'transition metal': return '#C0C0C0';
        case 'post-transition metal': return '#FFD700';
        case 'metalloid': return '#ADFF2F';
        case 'nonmetal': return '#77DD77';
        case 'halogen': return '#ffb3ba';
        case 'noble gas': return '#FFC0CB';
        case 'lanthanide': return '#ffcc99';
        case 'actinide': return '#ff9999';
        default: return '#999';
      }
    }
    function populateCell(cell, el){
      cell.textContent = el.symbol;
      const numSpan = document.createElement("span");
      numSpan.className = "atomic-number";
      numSpan.textContent = el.atomicNumber;
      cell.appendChild(numSpan);
      const catColor = getCategoryOutlineColor(el.category);
      cell.style.outline = `3px solid ${catColor}`;
      cell.style.outlineOffset = '-3px';
      cell.dataset.symbol = el.symbol;
      cell.dataset.name = el.name;
      cell.addEventListener("mouseover", (e) => {
        const tip = document.getElementById("elementTooltip");
        tip.innerHTML = `<strong>${el.name}</strong> [${el.symbol}]<br>${el.briefDesc || ''}`;
        tip.style.display = 'block';
        tip.style.left = (e.pageX + 10) + 'px';
        tip.style.top = (e.pageY + 10) + 'px';
      });
      cell.addEventListener("mousemove", (e) => {
        const tip = document.getElementById("elementTooltip");
        tip.style.left = (e.pageX + 10) + 'px';
        tip.style.top = (e.pageY + 10) + 'px';
      });
      cell.addEventListener("mouseout", () => {
        document.getElementById("elementTooltip").style.display = 'none';
      });
      cell.addEventListener("click", () => {
        // Add visual selection feedback
        selectCell(cell);
        
        if(isViewingPublic){
          openDetailsFor(el.symbol, true);
        } else if(quickStatusMode && isLoggedIn){
          setElementStatus(el.symbol, quickStatusValue);
        } else if(!quickStatusMode){
          openDetailsFor(el.symbol, false);
        } else {
          showToast("You must be logged in to modify statuses.", "warning");
        }
      });
    }
    function updateCommentBadges(){
      const mainCells = [...document.querySelectorAll('#periodicTable td[data-symbol]')];
      const lanCells = [...document.querySelectorAll('#lanthanideTable td[data-symbol]')];
      const actCells = [...document.querySelectorAll('#actinideTable td[data-symbol]')];
      const allCells = mainCells.concat(lanCells, actCells);
      allCells.forEach(cell => {
        const oldBadge = cell.querySelector('.comment-badge');
        if(oldBadge) oldBadge.remove();
        const sym = cell.dataset.symbol;
        const cnt = commentCounts[sym] || 0;
        if(cnt > 0){
          const badge = document.createElement("div");
          badge.className = "comment-badge";
          badge.textContent = cnt;
          cell.appendChild(badge);
        }
      });
    }
    function updateSampleBadges(){
      const mainCells = [...document.querySelectorAll('#periodicTable td[data-symbol]')];
      const lanCells = [...document.querySelectorAll('#lanthanideTable td[data-symbol]')];
      const actCells = [...document.querySelectorAll('#actinideTable td[data-symbol]')];
      const allCells = mainCells.concat(lanCells, actCells);
      allCells.forEach(cell => {
        const oldBadge = cell.querySelector('.sample-badge');
        if(oldBadge) oldBadge.remove();
        const sym = cell.dataset.symbol;
        const cnt = sampleCounts[sym] || 0;
        if(cnt > 0){
          const badge = document.createElement("div");
          badge.className = "sample-badge";
          badge.textContent = cnt;
          cell.appendChild(badge);
        }
      });
    }
    function refreshGalleryView(){
      const mainCells = [...document.querySelectorAll('#periodicTable td[data-symbol]')];
      const lanCells = [...document.querySelectorAll('#lanthanideTable td[data-symbol]')];
      const actCells = [...document.querySelectorAll('#actinideTable td[data-symbol]')];
      const allCells = mainCells.concat(lanCells, actCells);
      allCells.forEach(cell => {
        const sym = cell.dataset.symbol;
        const rec = elementDataStatus[sym];
        if(galleryMode && rec && rec.imageUrl){
          cell.style.backgroundImage = `url(${rec.imageUrl})`;
          cell.style.color = "#fff";
          cell.style.textShadow = "1px 1px 2px #000";
        } else {
          cell.style.backgroundImage = "none";
          cell.style.color = "";
          cell.style.textShadow = "";
        }
      });
    }
    function setElementStatus(symbol, status){
      if(!elementDataStatus[symbol]){
        elementDataStatus[symbol] = {status:'', description:'', imageUrl:'', quantity:0, purity:100};
      }
      elementDataStatus[symbol].status = status;
      refreshStatuses();
      updateCounters();
    }
    function refreshStatuses(){
      const mainCells = [...document.querySelectorAll('#periodicTable td[data-symbol]')];
      const lanCells = [...document.querySelectorAll('#lanthanideTable td[data-symbol]')];
      const actCells = [...document.querySelectorAll('#actinideTable td[data-symbol]')];
      const allCells = mainCells.concat(lanCells, actCells);
      allCells.forEach(cell => {
        cell.classList.remove("status-pure", "status-rep", "status-alloy", "status-wish");
        const sym = cell.dataset.symbol;
        const rec = elementDataStatus[sym];
        if(rec && rec.status){
          if(rec.status === "Pure") cell.classList.add("status-pure");
          else if(rec.status === "Representative") cell.classList.add("status-rep");
          else if(rec.status === "Alloy") cell.classList.add("status-alloy");
          else if(rec.status === "Wish") cell.classList.add("status-wish");
        }
      });
      refreshGalleryView();
    }
    document.getElementById("quickStatusCheckbox").addEventListener("change", e => {
      quickStatusMode = e.target.checked;
    });
    document.getElementById("quickStatusDropdown").addEventListener("change", e => {
      quickStatusValue = e.target.value;
    });
    document.getElementById("galleryViewCheckbox").addEventListener("change", e => {
      galleryMode = e.target.checked;
      refreshGalleryView();
    });
    document.getElementById("toggleStickyBtn").addEventListener("click", function(){
      const container = document.querySelector(".periodic-container");
      if(container.classList.contains("sticky-fixed")){
        container.classList.remove("sticky-fixed");
        this.textContent = "Stick Table";
      } else {
        container.classList.add("sticky-fixed");
        this.textContent = "Unstick Table";
      }
    });
    function openDetailsFor(symbol, readOnly){
      currentSymbol = symbol;
      const el = elementsData.find(e => e.symbol === symbol);
      const rec = elementDataStatus[symbol] || {status:'', description:'', imageUrl:'', quantity:0, purity:100};
      detailsPanel.classList.remove("edit-mode", "view-mode");
      if(readOnly){
        detailsPanel.classList.add("view-mode");
      } else {
        detailsPanel.classList.add("edit-mode");
      }
      document.getElementById("elementTitle").textContent =
        el ? `${el.name} (${el.symbol})` : symbol;
      const editFieldsDiv = document.getElementById("editFields");
      editFieldsDiv.style.display = readOnly ? 'none' : 'block';
      document.getElementById("statusSelect").value  = rec.status || '';
      document.getElementById("descArea").value      = rec.description || '';
      document.getElementById("quantityInput").value = rec.quantity || 0;
      document.getElementById("purityInput").value   = rec.purity || 100;
      document.getElementById("imgUrlInput").value   = rec.imageUrl || '';
      const pv = document.getElementById("previewImg");
      const plink = document.getElementById("previewLink");
      if(rec.imageUrl){
        pv.src = rec.imageUrl;
        plink.href = rec.imageUrl;
        plink.style.display = 'block';
        pv.style.display = 'block';
      } else {
        pv.src = '';
        plink.style.display = 'none';
        pv.style.display = 'none';
      }
      refreshStatuses();
      loadCommentsFor(isViewingPublic ? viewedUser : loggedInUser, symbol);
      loadSamplesFor(isViewingPublic ? viewedUser : loggedInUser, symbol);
      if(isViewingPublic){
        document.getElementById("sampleTools").style.display = "none";
      } else {
        document.getElementById("sampleTools").style.display = "block";
      }
      // In the comment section, if not logged in show inline login UI; else show post area.
      if(isLoggedIn){
         document.getElementById("commentLoginSection").style.display = "none";
         document.getElementById("commentPostSection").style.display = "block";
         document.getElementById("commentingAs").innerHTML = `<strong>Commenting as:</strong> ${loggedInUser}`;
      } else {
         document.getElementById("commentLoginSection").style.display = "block";
         document.getElementById("commentPostSection").style.display = "none";
      }
    }
    function loadCommentsFor(ownerUsername, symbol){
      if(!ownerUsername || !symbol){
        document.getElementById("commentsContainer").innerHTML = "";
        return;
      }
      fetch(`/comments?ownerUsername=${ownerUsername}&symbol=${symbol}`)
        .then(resp => resp.json())
        .then(data => {
          if(data.status === "success"){
            const container = document.getElementById("commentsContainer");
            container.innerHTML = data.comments.map(c => {
              // Make non-"Guest" usernames clickable.
              let usernameHTML = (c.commenter_username !== "Guest") ?
                `<a href="#" onclick="viewUserProfile('${c.commenter_username}'); return false;">${c.commenter_username}</a>` :
                c.commenter_username;
              return `<p><strong>${usernameHTML}</strong>: ${c.comment_text}</p>`;
            }).join("");
          } else {
            document.getElementById("commentsContainer").innerHTML = `<p style="color:red;">${data.message || 'Error'}</p>`;
          }
        })
        .catch(err => console.error("Comment fetch error:", err));
    }
    function loadSamplesFor(ownerUsername, symbol){
      if(!ownerUsername || !symbol){
        document.getElementById("samplesList").innerHTML = "";
        return;
      }
      fetch(`/samples?ownerUsername=${ownerUsername}&symbol=${symbol}`)
        .then(resp => resp.json())
        .then(data => {
          const container = document.getElementById("samplesList");
          if(data.status === "success"){
            if(data.samples.length === 0){
              container.innerHTML = "<p>No samples yet.</p>";
            } else {
              samplesData = {};
              container.innerHTML = data.samples.map(s => {
                samplesData[s.id] = s;
                let buttons = "";
                if(!isViewingPublic) {
                  buttons = `<button onclick="editSample(${s.id})">Edit</button>
                             <button onclick="deleteSample(${s.id})">Delete</button>`;
                }
                // Wrap sample image in an anchor so it is clickable; float image left.
                let imageHTML = "";
                if(s.image_url){
                  imageHTML = `<a href="${s.image_url}" target="_blank" style="float:left; margin-right:10px;">
                                  <img src="${s.image_url}" alt="Sample Image" style="max-width:100px;">
                                </a>`;
                }
                return `<div style="overflow:auto; border:1px solid #ccc; padding:5px; margin-bottom:5px;">
                           ${imageHTML}
                           <div>
                             <strong>Status:</strong> ${s.status}<br>
                             <strong>Description:</strong> ${s.description}<br>
                             <strong>Quantity:</strong> ${s.quantity}<br>
                             <strong>Purity:</strong> ${s.purity}<br>
                             <small>Added: ${s.created_at}</small><br>
                             ${buttons}
                           </div>
                         </div>`;
              }).join("");
            }
          } else {
            container.innerHTML = `<p style="color:red;">${data.message || 'Error'}</p>`;
          }
        })
        .catch(err => console.error("Samples fetch error:", err));
    }
    // NEW FUNCTIONS FOR SAMPLE EDITING/DELETION
    function editSample(id) {
      const sample = samplesData[id];
      if(!sample) return;
      editingSampleId = id;
      document.getElementById("sampleStatusSelect").value = sample.status;
      document.getElementById("sampleDesc").value = sample.description;
      document.getElementById("sampleImgUrl").value = sample.image_url;
      document.getElementById("sampleQuantity").value = sample.quantity;
      document.getElementById("samplePurity").value = sample.purity;
      document.getElementById("addSampleForm").style.display = "block";
    }
    function deleteSample(id) {
      if(!confirm("Are you sure you want to delete this sample?")) return;
      fetch(`/samples/${id}`, {
        method: "DELETE",
        credentials: "include"
      })
      .then(resp => resp.json())
      .then(res => {
        if(res.status === "success"){
           alert("Sample deleted!");
           loadSamplesFor(isViewingPublic ? viewedUser : loggedInUser, currentSymbol);
           fetchSampleCounts(isViewingPublic ? viewedUser : loggedInUser);
           fetchCommentCounts(isViewingPublic ? viewedUser : loggedInUser);
        } else {
           alert("Delete failed: " + (res.message || "Unknown"));
        }
      })
      .catch(err => {
         console.error("Delete sample error:", err);
         showToast("Delete sample request failed: " + err, "error");
      });
    }
    document.getElementById("statusSelect").addEventListener("change", updateCurrentElementRecord);
    document.getElementById("descArea").addEventListener("input", updateCurrentElementRecord);
    document.getElementById("quantityInput").addEventListener("change", updateCurrentElementRecord);
    document.getElementById("purityInput").addEventListener("change", updateCurrentElementRecord);
    function updateCurrentElementRecord(){
      if(!currentSymbol || !isLoggedIn) return;
      if(!elementDataStatus[currentSymbol]){
        elementDataStatus[currentSymbol] = {status:'', description:'', imageUrl:'', quantity:0, purity:100};
      }
      const rec = elementDataStatus[currentSymbol];
      rec.status      = document.getElementById("statusSelect").value || '';
      rec.description = document.getElementById("descArea").value || '';
      rec.imageUrl    = document.getElementById("imgUrlInput").value || '';
      rec.quantity    = Number(document.getElementById("quantityInput").value) || 0;
      rec.purity      = Number(document.getElementById("purityInput").value) || 100;
      updateCounters();
      refreshStatuses();
    }
    document.getElementById("setUrlBtn").addEventListener("click", () => {
      if(!isLoggedIn){
        alert("You must be logged in to set an image URL.");
        return;
      }
      updateCurrentElementRecord();
      const url = document.getElementById("imgUrlInput").value;
      const pv = document.getElementById("previewImg");
      const plink = document.getElementById("previewLink");
      if(url){
        pv.src = url;
        plink.href = url;
        plink.style.display = 'block';
        pv.style.display = 'block';
      } else {
        pv.src = '';
        plink.style.display = 'none';
        pv.style.display = 'none';
      }
    });
    document.getElementById("uploadBtn").addEventListener("click", async () => {
      if(!isLoggedIn){
        alert("Login first.");
        return;
      }
      if(!currentSymbol){
        alert("Select an element first.");
        return;
      }
      const fi = document.getElementById("imgFileInput");
      if(!fi.files || !fi.files[0]){
        alert("No file selected.");
        return;
      }
      const formData = new FormData();
      formData.append("image", fi.files[0]);
      try{
        const resp = await fetch(`/upload/${encodeURIComponent(currentSymbol)}`, {
          method: "POST",
          credentials: "include",
          body: formData
        });
        const data = await resp.json();
        if(data.status === "success"){
          alert("Uploaded!");
          if(!elementDataStatus[currentSymbol]){
            elementDataStatus[currentSymbol] = {status:'', description:'', imageUrl:'', quantity:0, purity:100};
          }
          elementDataStatus[currentSymbol].imageUrl = data.imageUrl;
          document.getElementById("imgUrlInput").value = data.imageUrl;
          const pv = document.getElementById("previewImg");
          const plink = document.getElementById("previewLink");
          pv.src = data.imageUrl;
          plink.href = data.imageUrl;
          plink.style.display = 'block';
          pv.style.display = 'block';
          refreshStatuses();
        } else {
          alert("Upload error: " + (data.message || 'Unknown'));
        }
      } catch(err) {
        showToast("Upload request failed: " + err, "error");
      }
    });
    // Sample file upload for samples
    document.getElementById("uploadSampleBtn").addEventListener("click", async () => {
      if(!isLoggedIn){
        alert("Login first.");
        return;
      }
      if(!currentSymbol){
        alert("Select an element first.");
        return;
      }
      const fi = document.getElementById("sampleImgFile");
      if(!fi.files || !fi.files[0]){
        alert("No sample file selected.");
        return;
      }
      const formData = new FormData();
      formData.append("image", fi.files[0]);
      try{
        const resp = await fetch(`/uploadSample/${encodeURIComponent(currentSymbol)}`, {
          method: "POST",
          credentials: "include",
          body: formData
        });
        const data = await resp.json();
        if(data.status === "success"){
          alert("Sample file uploaded!");
          document.getElementById("sampleImgUrl").value = data.imageUrl;
        } else {
          alert("Sample file upload error: " + (data.message || 'Unknown'));
        }
      } catch(err) {
        showToast("Sample file upload request failed: " + err, "error");
      }
    });
    document.getElementById("showAddSampleBtn").addEventListener("click", () => {
      editingSampleId = null;
      document.getElementById("addSampleForm").style.display = "block";
    });
    document.getElementById("cancelSampleBtn").addEventListener("click", () => {
      editingSampleId = null;
      document.getElementById("addSampleForm").style.display = "none";
    });
    document.getElementById("submitSampleBtn").addEventListener("click", () => {
      if(!isLoggedIn){
        alert("You must be logged in to add a sample.");
        return;
      }
      if(!currentSymbol){
        alert("Select an element first.");
        return;
      }
      const sampleData = {
        symbol: currentSymbol,
        status: document.getElementById("sampleStatusSelect").value || '',
        description: document.getElementById("sampleDesc").value || '',
        imageUrl: document.getElementById("sampleImgUrl").value || '',
        quantity: Number(document.getElementById("sampleQuantity").value) || 0,
        purity: Number(document.getElementById("samplePurity").value) || 100
      };
      if(editingSampleId){
         // Update sample via PUT
         fetch(`/samples/${editingSampleId}`, {
           method: "PUT",
           headers: {"Content-Type": "application/json"},
           credentials: "include",
           body: JSON.stringify(sampleData)
         })
         .then(r => r.json())
         .then(res => {
           if(res.status === "success"){
             alert("Sample updated!");
             editingSampleId = null;
             document.getElementById("addSampleForm").style.display = "none";
             loadSamplesFor(isViewingPublic ? viewedUser : loggedInUser, currentSymbol);
             fetchSampleCounts(isViewingPublic ? viewedUser : loggedInUser);
             fetchCommentCounts(isViewingPublic ? viewedUser : loggedInUser);
           } else {
             alert("Failed to update sample: " + (res.message || 'Unknown'));
           }
         })
         .catch(err => {
           console.error("Sample update error:", err);
           showToast("Sample update request failed: " + err, "error");
         });
      } else {
         // Add new sample via POST
         fetch("/samples", {
           method: "POST",
           headers: {"Content-Type": "application/json"},
           credentials: "include",
           body: JSON.stringify(sampleData)
         })
         .then(r => r.json())
         .then(res => {
           if(res.status === "success"){
             alert("Sample added!");
             document.getElementById("addSampleForm").style.display = "none";
             loadSamplesFor(isViewingPublic ? viewedUser : loggedInUser, currentSymbol);
             fetchSampleCounts(isViewingPublic ? viewedUser : loggedInUser);
             fetchCommentCounts(isViewingPublic ? viewedUser : loggedInUser);
           } else {
             alert("Failed to add sample: " + (res.message || 'Unknown'));
           }
         })
         .catch(err => {
           console.error("Sample post error:", err);
           showToast("Sample request failed: " + err, "error");
         });
      }
    });
    // Enhanced with loading feedback
    function fetchSampleCounts(ownerUsername){
      sampleCounts = {};
      if(!ownerUsername) return;
      
      // Show loading indicator
      document.body.style.cursor = 'wait';
      
      fetch(`/samples/count?ownerUsername=${ownerUsername}`)
        .then(resp => resp.json())
        .then(data => {
          if(data.status === "success"){
            sampleCounts = data.counts || {};
            const elementCount = Object.keys(sampleCounts).length;
            if(elementCount > 0) {
              showToast(`Loaded samples for ${elementCount} elements`, 'success', 2000);
            }
          } else {
            console.warn("Could not load sample counts:", data.message || 'Error');
            sampleCounts = {};
            showToast("Could not load sample counts", 'warning', 2000);
          }
          updateSampleBadges();
        })
        .catch(err => {
          console.error("Sample counts fetch error:", err);
          sampleCounts = {};
          updateSampleBadges();
          showToast("Failed to load sample data", 'error', 3000);
        })
        .finally(() => {
          document.body.style.cursor = 'default';
        });
    }
    function updateCounters(){
      let pure = 0, rep = 0, alloy = 0, wish = 0;
      for(const sym in elementDataStatus){
        const st = elementDataStatus[sym].status;
        if(st === "Pure") pure++;
        else if(st === "Representative") rep++;
        else if(st === "Alloy") alloy++;
        else if(st === "Wish") wish++;
      }
      document.getElementById("counters").textContent =
        `Pure:${pure}, Rep:${rep}, Alloy:${alloy}, Wish:${wish}, Total:${pure+rep+alloy+wish}`;
      showPieChart(pure, rep, alloy, wish);
    }
    function showPieChart(pure, rep, alloy, wish){
      const ctx = document.getElementById("statusChart").getContext("2d");
      if(myChart) myChart.destroy();
      myChart = new Chart(ctx, {
        type: "pie",
        data: {
          labels: ["Pure", "Rep", "Alloy", "Wish"],
          datasets: [{
            data: [pure, rep, alloy, wish],
            backgroundColor: ["green", "orange", "blue", "purple"]
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: "bottom" } }
        }
      });
    }
    document.getElementById("loginLoadBtn").addEventListener("click", loginAndLoad);
    async function loginAndLoad(){
      const username = document.getElementById("usernameInput").value.trim();
      const password = document.getElementById("passwordInput").value;
      const loginBtn = document.getElementById("loginLoadBtn");
      
      if(!username || !password){
        showToast("Please enter username and password.", "warning");
        return;
      }
      
      setButtonLoading(loginBtn, true);
      
      try{
        let resp = await fetch("/auth/login", {
          method: "POST",
          credentials: "include",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({username, password})
        });
        let data = await resp.json();
        if(data.status !== "success"){
          showToast("Login error: " + (data.message || "Unknown"), "error");
          setButtonLoading(loginBtn, false);
          return;
        }
        showToast("Successfully logged in!", "success");
        if(data.newUser) {
          showToast("Welcome new user! Please update your profile in Profile Settings.", "info", 5000);
        }
        isLoggedIn = true;
        loggedInUser = username;
        isViewingPublic = false;
        viewedUser = null;
        logoutBtn.style.display = 'inline-block';
        updateUserStatusBar();
        detailsPanel.classList.remove("view-mode");
        detailsPanel.classList.add("edit-mode");
        
        showToast("Loading your data...", "info");
        resp = await fetch("/user", {credentials:"include"});
        data = await resp.json();
        if(data.status === "success"){
          elementDataStatus = data.statuses || {};
          updateCounters();
          refreshStatuses();
          showToast("Data loaded successfully for " + username, "success");
        } else {
          showToast("Could not load data: " + (data.message || "Unknown"), "error");
        }
        fetchCommentCounts(username);
        fetchSampleCounts(username);
      } catch(err) {
        showToast("Login request failed: " + err, "error");
      } finally {
        setButtonLoading(loginBtn, false);
      }
    }
    document.getElementById("saveBtn").addEventListener("click", saveData);
    async function saveData(){
      if(!isLoggedIn){
        alert("You must be logged in to save.");
        return;
      }
      let statuses = {};
      Object.keys(elementDataStatus).forEach(sym => {
        statuses[sym] = elementDataStatus[sym];
      });
      fetch("/user", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        credentials: "include",
        body: JSON.stringify({statuses})
      })
      .then(r => r.json())
      .then(res => {
        console.log("Save response:", res);
        alert("Save successful!");
      })
      .catch(err => {
        console.error("Save error:", err);
      });
    }
    async function logoutUser(){
      try{
        const resp = await fetch("/auth/logout", {method: "POST", credentials: "include"});
        const data = await resp.json();
        if(data.status === "success"){
          alert("Logged out.");
          isLoggedIn = false;
          loggedInUser = null;
          isViewingPublic = false;
          viewedUser = null;
          elementDataStatus = {};
          updateCounters();
          refreshStatuses();
          logoutBtn.style.display = 'none';
          updateUserStatusBar();
          detailsPanel.classList.remove("edit-mode");
          detailsPanel.classList.add("view-mode");
          
          // Reset buttons to default state
          resetButtonsToDefault();
        }
      } catch(err){
        showToast("Logout failed: " + err, "error");
      }
    }
    document.getElementById("logoutBtn").addEventListener("click", logoutUser);
    document.getElementById("viewBtn").addEventListener("click", viewPublic);
    async function viewPublic(){
      const user = document.getElementById("viewUsernameInput").value.trim();
      if(!user){
        showToast("Enter a username to view.", "warning");
        return;
      }
      
      showToast("Loading collection...", "info", 2000);
      
      try{
        const resp = await fetch("/public/" + encodeURIComponent(user), {credentials:"include"});
        const data = await resp.json();
        if(data.status === "success"){
          showToast(`Loaded public collection of ${user}`, "success");
          isLoggedIn = false;
          loggedInUser = null;
          isViewingPublic = true;
          viewedUser = user;
          elementDataStatus = data.statuses || {};
          updateCounters();
          refreshStatuses();
          logoutBtn.style.display = 'none';
          updateUserStatusBar();
          fetchCommentCounts(user);
          fetchSampleCounts(user);
          detailsPanel.classList.remove("edit-mode");
          detailsPanel.classList.add("view-mode");
          
          // Fetch user profile info and update buttons with profile picture
          updateButtonsWithProfile(user);
        } else {
          showToast("View error: " + (data.message || "User not found or collection not public"), "error");
        }
      } catch(err){
        showToast("Failed to view user's data: " + err, "error");
      }
    }
    
    // Function to update buttons with user profile picture when viewing public collection
    async function updateButtonsWithProfile(username) {
      try {
        const resp = await fetch("/publicinfo/" + encodeURIComponent(username), {credentials:"include"});
        const data = await resp.json();
        
        if(data.status === "success") {
          // Update Author Info button
          const authorInfoBtn = document.getElementById("viewOwnerInfoBtn");
          const profileImageUrl = data.profile_image_url;
          const displayName = data.display_name || username;
          const userInitials = displayName.split(' ').map(word => word.charAt(0).toUpperCase()).slice(0, 2).join('');
          
          // Create avatar element
          let avatarElement;
          if (profileImageUrl) {
            avatarElement = `<img src="${profileImageUrl}" class="btn-avatar" alt="${displayName}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="btn-avatar-placeholder" style="display:none;">${userInitials}</div>`;
          } else {
            avatarElement = `<div class="btn-avatar-placeholder">${userInitials}</div>`;
          }
          
          // Update button content
          authorInfoBtn.innerHTML = `${avatarElement} ${displayName} Info`;
          authorInfoBtn.className = 'btn-with-avatar';
          
          // Also update the View button to show it's viewing this user
          const viewBtn = document.getElementById("viewBtn");
          const viewInput = document.getElementById("viewUsernameInput");
          viewInput.value = `Viewing: ${displayName}`;
          viewInput.disabled = true;
          viewBtn.innerHTML = `${avatarElement} Switch User`;
          viewBtn.className = 'btn-with-avatar';
          
          // Add click handler to switch user
          viewBtn.onclick = function() {
            viewInput.disabled = false;
            viewInput.value = '';
            viewInput.placeholder = 'View user (public)';
            viewBtn.innerHTML = 'View';
            viewBtn.className = '';
            viewBtn.onclick = null;
            
            // Reset to logged in user view if available
            if (loggedInUser) {
              isViewingPublic = false;
              viewedUser = null;
              isLoggedIn = true;
              updateUserStatusBar();
              detailsPanel.classList.remove("view-mode");
              detailsPanel.classList.add("edit-mode");
              
              // Restore original button content
              authorInfoBtn.innerHTML = 'Author Info';
              authorInfoBtn.className = '';
            }
          };
        }
      } catch (err) {
        console.error("Failed to fetch user profile for buttons:", err);
      }
    }
    
    // Function to reset buttons to default state
    function resetButtonsToDefault() {
      const authorInfoBtn = document.getElementById("viewOwnerInfoBtn");
      const viewBtn = document.getElementById("viewBtn");
      const viewInput = document.getElementById("viewUsernameInput");
      
      authorInfoBtn.innerHTML = 'Author Info';
      authorInfoBtn.className = '';
      
      viewBtn.innerHTML = 'View';
      viewBtn.className = '';
      viewBtn.onclick = null;
      
      viewInput.disabled = false;
      viewInput.value = '';
      viewInput.placeholder = 'View user (public)';
    }
    
    // New function to view a user's profile info (used when clicking a comment username or Author Info)
    async function viewUserProfile(username) {
      try {
         const resp = await fetch("/publicinfo/" + encodeURIComponent(username), {credentials:"include"});
         const data = await resp.json();
         if(data.status === "success"){
             let html = `<h2>${data.display_name}</h2>`;
             if(data.bio) html += `<p>${data.bio}</p>`;
             if(data.profile_image_url) html += `<img src="${data.profile_image_url}" alt="Profile">`;
             if(data.achievements && data.achievements.length > 0){
               html += `<div style="margin-top:8px;"><strong>Achievements:</strong><br>`;
               data.achievements.forEach(badgeName => {
                 const icon = { "All Alkali Metals": "/static/achv_alkali.png", "All Noble Gases": "/static/achv_nobles.png", "First 10 Elements": "/static/achv_first10.png" }[badgeName] || "/static/generic_badge.png";
                 html += `<img src="${icon}" class="achievement-badge" title="${badgeName}" alt="${badgeName}">`;
               });
               html += `</div>`;
             }
             if(data.collection_stats) {
                 html += `<div style="margin-top:8px;"><strong>Collection Stats:</strong><br>
                          Pure: ${data.collection_stats.pure_count}, Rep: ${data.collection_stats.rep_count}, Alloy: ${data.collection_stats.alloy_count}, Total: ${data.collection_stats.total_collected}
                          </div>`;
             }
             document.getElementById("authorInfoContent").innerHTML = html;
         } else {
             document.getElementById("authorInfoContent").innerHTML = `<p>Error: ${data.message || ''}</p>`;
         }
         document.getElementById("authorInfoModal").style.display = 'block';
      } catch(err){
         showToast("Failed to fetch user profile: " + err, "error");
      }
    }
    // Add event listener for the author info modal close button
    document.getElementById("authorInfoClose").addEventListener("click", () => {
      document.getElementById("authorInfoModal").style.display = "none";
    });
    document.getElementById("viewOwnerInfoBtn").addEventListener("click", () => {
      if(!viewedUser){
        alert("Must be viewing a public user.");
        return;
      }
      viewUserProfile(viewedUser);
    });
    // Inline comment login: if not logged in, allow login in the comment section.
    document.getElementById("commentLoginBtn").addEventListener("click", async function(){
       const username = document.getElementById("commentLoginUsername").value.trim();
       const password = document.getElementById("commentLoginPassword").value;
       if(!username || !password) {
          alert("Enter username and password.");
          return;
       }
       try{
          let resp = await fetch("/auth/login", {
              method: "POST",
              credentials: "include",
              headers: {"Content-Type": "application/json"},
              body: JSON.stringify({username, password})
          });
          let data = await resp.json();
          if(data.status !== "success"){
             alert("Login error: " + (data.message || "Unknown"));
             return;
          }
          alert("Logged in!");
          isLoggedIn = true;
          loggedInUser = username;
          document.getElementById("commentLoginSection").style.display = "none";
          document.getElementById("commentPostSection").style.display = "block";
          document.getElementById("commentingAs").innerHTML = `<strong>Commenting as:</strong> ${loggedInUser}`;
          updateUserStatusBar();
       } catch(err){
          showToast("Login request failed: " + err, "error");
       }
    });
    // Comment posting – now the inline login form ensures the user is logged in.
    document.getElementById("postCommentBtn").addEventListener("click", () => {
      if(!isLoggedIn){
         alert("Please log in to post a comment.");
         return;
      }
      const commentText = document.getElementById("commentInput").value.trim();
      if(!commentText){
        alert("Please enter a comment.");
        return;
      }
      const ownerUsername = isViewingPublic ? viewedUser : loggedInUser;
      const symbol = currentSymbol;
      const payload = {
         ownerUsername: ownerUsername,
         symbol: symbol,
         commentText: commentText
      };
      fetch("/comments", {
         method: "POST",
         headers: {"Content-Type": "application/json"},
         credentials: "include",
         body: JSON.stringify(payload)
      })
      .then(r => r.json())
      .then(data => {
         if(data.status === "success"){
             alert("Comment posted");
             document.getElementById("commentInput").value = "";
             loadCommentsFor(ownerUsername, symbol);
             fetchCommentCounts(ownerUsername);
         } else {
             alert("Error posting comment: " + (data.message || "Unknown"));
         }
      })
      .catch(err => {
         console.error("Comment post error:", err);
         showToast("Comment request failed: " + err, "error");
      });
    });
    function fetchCommentCounts(ownerUsername){
      commentCounts = {};
      if(!ownerUsername) return;
      fetch(`/comments/count?ownerUsername=${ownerUsername}`)
        .then(resp => resp.json())
        .then(data => {
          if(data.status === "success"){
            commentCounts = data.counts || {};
          } else {
            console.warn("Could not load comment counts:", data.message || 'Error');
            commentCounts = {};
          }
          updateCommentBadges();
        })
        .catch(err => {
          console.error("Comment counts fetch error:", err);
          commentCounts = {};
          updateCommentBadges();
        });
    }
    function updateUserStatusBar(){
      if(isViewingPublic && viewedUser){
        userStatusBar.textContent = `Viewing public collection of: ${viewedUser}`;
      } else if(isLoggedIn && loggedInUser){
        userStatusBar.textContent = `Logged in as: ${loggedInUser}`;
      } else {
        userStatusBar.textContent = "Not logged in.";
      }
    }
    window.addEventListener("load", () => {
      buildMainTable();
      buildLanthanideTable();
      buildActinideTable();
      refreshStatuses();
      updateCounters();
      updateUserStatusBar();
      
      // Check for ?view=username parameter and auto-load that user
      const urlParams = new URLSearchParams(window.location.search);
      const viewUser = urlParams.get('view');
      if (viewUser) {
        // Set the view username input and trigger view
        document.getElementById('viewUsernameInput').value = viewUser;
        // Use setTimeout to ensure page is fully loaded
        setTimeout(() => {
          viewPublic();
        }, 500);
      }
    });
  </script>
</body>
</html>
